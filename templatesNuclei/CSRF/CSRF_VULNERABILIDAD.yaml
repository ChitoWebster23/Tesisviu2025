id: CSRF_VALIDADO

info:
  name: CSRF - Cambio de contraseña sin token
  severity: high
  author: Fabian Morales
  description: |
    Detecta vulnerabilidades CSRF en funcionalidades de cambio de contraseña
    que no implementan tokens anti-CSRF.
  reference:
    - https://owasp.org/www-community/attacks/csrf
  tags: csrf,web,security,auth

variables:
  new_password: "nuclei_test_{{rand_int(1000,9999)}}"

http:
  - raw:
      - |
        GET /login HTTP/1.1
        Host: {{Hostname}}
        User-Agent: Mozilla/5.0

      - |
        POST /login HTTP/1.1
        Host: {{Hostname}}
        Content-Type: application/x-www-form-urlencoded
        User-Agent: Mozilla/5.0

        username=admin&password=password&Login=Login

      - |
        GET /csrf/ HTTP/1.1
        Host: {{Hostname}}
        User-Agent: Mozilla/5.0

      - |
        GET /csrf/?password_new=contraseña&password_conf=contraseña&Change=Change HTTP/1.1
        Host: {{Hostname}}
        User-Agent: Mozilla/5.0

    cookie-reuse: true
    matchers:
      - type: word
        words:
          - "Password Changed"
          - "contraseña cambiada"
          - "password changed"
          - "successfully changed"
        part: body
        condition: or

    extractors:
      - type: regex
        name: csrf_token
        part: body
        regex:
          - 'name="user_token" value="([a-f0-9]{32})"'
          - 'csrf_token" value="([^"]+)"'
        group: 1